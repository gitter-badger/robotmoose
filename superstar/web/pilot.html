<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">


<script type=text/javascript>
/*
  JSON Testing
  Dr. Orion Lawlor, lawlor@alaska.edu, 2012-02-17
*/


/* Main update: display costs for user's selected values. */
function run() {
  document.getElementById('p_errorout').innerHTML="";
  try {
	
  } catch (err) {
    document.getElementById('p_errorout').innerHTML="Exception: "+err;
  }
}

/* Walk the DOM to get the client X,Y position of this element's topleft corner.
  From www.kirupa.com/snippets/examples/move_to_click_position.htm */
function getClientPosition(element) {
	var xPosition = 0;
	var yPosition = 0;
	while (element) {
		xPosition += (element.offsetLeft - element.scrollLeft + element.clientLeft);
		yPosition += (element.offsetTop - element.scrollTop + element.clientTop);
		element = element.offsetParent;
	}
	return { x: xPosition, y: yPosition };
}
/* Return the fractional mouse position of the mouse relative to this element.
   Returns x=0.0 at the left edge, x=1.0 at the right edge;
           y=0.0 at the top edge, y=1.0 at the bottom edge. */
function getMouseFraction(event,domElement) {
  var corner=getClientPosition(domElement);
  var xFrac=(event.clientX-corner.x)/domElement.scrollWidth;
  var yFrac=(event.clientY-corner.y)/domElement.scrollHeight;
  return { x:xFrac, y:yFrac };
}

// Round this number to the nearest thousandth, making it look pretty.
function pretty(number) {
	return Math.round(number*1000)/1000.0;
}
// Clamp this value between lo and hi
function clamp(v,lo,hi) {
	if (v<lo) return lo;
	if (v>hi) return hi;
	return v;
}

// Return an "empty" robot power object, with everything stationary
function emptyPower() 
{
	return {L:0, R:0, dump:0, mine:0, arms:0};
}

// This class stores our last-used piloting command
var pilot={
	/* Power to each actuator */
	power: emptyPower(),
	
	/* Time, in seconds, of last pilot command */
	time:0,
	/* Authorization hash (todo) */
	auth:"ffe0"
};

// Return the current wall clock time, in seconds
function pilot_time() {
	return (new Date()).getTime()/1000.0;
}

// This counts outstanding network requests
var networkBusy=0;

// Send our last-used piloting command out across the network
function pilot_send() {
	var host=// "http://localhost:8080"+ // <- explicit host not needed, browser will use the .html server by default.
		"/superstar/";
	var robot=document.getElementById('robot_name').value;
	var url_start=host+robot;
	
	if (networkBusy>1) 
	{ // prevent overloading network: skip sending if already busy
		document.getElementById('p_outputNet').innerHTML="network lag";
		return;
	}

	networkBusy++; 
	var send_time=pilot.time=pilot_time();
	var pilotStr=JSON.stringify(pilot);
	var url=url_start+"/pilot?set="+encodeURIComponent(pilotStr);
	var xmlhttp=new XMLHttpRequest();
	xmlhttp.onreadystatechange=function()
	{ // this function called when network progress happens
		if(xmlhttp.readyState!=4) return;
		var status="Network Error";
		if (xmlhttp.status==200)
		{
			status="Data sent at t="+send_time+" ("+pretty(pilot_time()-send_time)+" second roundtrip)";
			if (networkBusy>1) status+=" ["+networkBusy+" requests in flight]";
		}
		document.getElementById('p_outputNet').innerHTML=status;
		networkBusy--;
	}
	xmlhttp.open("GET",url,true);
	xmlhttp.send(null);
}

// This function is called at every mouse event.
//   upState: 0 if down, 1 if up, 2 if not changing
var mouse_down=0;
function pilot_mouse(event,upState) {
	var maxPower=0.4;
	var arrowDiv=document.getElementById('pilot_arrows');
	var frac=getMouseFraction(event,arrowDiv);
	var str="";
	str+="Mouse "+frac.x+" "+frac.y+"<br>\n";

	var dir={ forward: pretty(0.5-frac.y), turn:pretty(frac.x-0.5) };
	// if (Math.abs(dir.turn)<0.1) dir.turn=0; // <- turning deadband
	str+="Move "+dir.forward+" forward, "+dir.turn+" turn<br>\n";
	var totPower=Math.abs(dir.forward)+Math.abs(dir.turn);
	var newPower=emptyPower();
	if (frac.x<0.9) { /* normal driving */
		newPower.L=pretty(clamp(dir.forward+dir.turn,-maxPower,maxPower));
		newPower.R=pretty(clamp(dir.forward-dir.turn,-maxPower,maxPower)); 
	} else { /* right hand corner of screen: special magic values */
		if (frac.y<0.33) {
			newPower.dump=pretty((1.0/6-frac.y)*3);
		} else if (frac.y<0.66) {
			newPower.mine=pretty((3.0/6-frac.y)*3);
		} else {
			newPower.arms=pretty((5.0/6-frac.y)*3);
		}
	}
	var newPowerStr=JSON.stringify(newPower);
	str+="Power "+newPower.L+" left, "+newPower.R+" right, "+newPowerStr+" ";

	if (upState==1) mouse_down=0;
	if (upState==0) mouse_down=1;
	if (mouse_down) {
		arrowDiv.style.backgroundColor='#000000';
		str+=" SENDING";
	} else {
		arrowDiv.style.backgroundColor='#404040';
		newPower=emptyPower();
		totPower=0;
		str+=" (click to send)";
	}
	pilot.power=newPower;
	pilot_send();

	document.getElementById('p_outputPilot').innerHTML=str;

	document.getElementById('glow').style.opacity=clamp(totPower*3.0,0.0,1.0);
	event.stopPropagation();
}

</script>


<head><title>Pilot for ITEST: Being There</title>

</head>

<body onLoad="run()">
<h1>ITEST: Being There Pilot Interface</h1>

<div id="pilot_arrows" style="background-color:#808080;position:relative;width:400px;height:400px;" onmousedown="pilot_mouse(event,0)" ondblclick="pilot_mouse(event,2)" ondragstart="pilot_mouse(event,0)" onmouseout="pilot_mouse(event,1)"  onmouseup="pilot_mouse(event,1)" onmousemove="pilot_mouse(event,2)">
<img src="img/arrows_hard.png" style="position:absolute;left:0px;top:0px;width:100%;height:100%;pointer-events:none;">
<img id="glow" src="img/arrows_glow.png" style="position:absolute;left:0px;top:0px;width:100%;height:100%;pointer-events:none;">
</div>

<form name="costEst">

<p>Robot Name: <input type="text" id="robot_name" rows="1" cols="30" onChange="run()" value="layla/uaf"><br>
Pilot Auth: <input type="text" id="robot_auth" rows="1" cols="30" onChange="run()" value=""></p>

<!-- <p><input name="Run" value="Go!" type="button" onClick="run()"></p>  -->
</form>

<P id="p_errorout" style="color:red;">ERROR: JavaScript not enabled.</p>

<div id="status_area" style="font-style:italic;">
<P id="p_outputRobot">Robot Status</p>
<P id="p_outputNet">Network Status</p>
<P id="p_outputPilot">Pilot Status</p>
</div>

</body></html>

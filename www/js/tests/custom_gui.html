<html lang="en">
	<head>
		<!--#include virtual="/sources.html"-->
		<!--#include virtual="/navbar.html"-->
	</head>
	<body role="document">
		<div style="padding-top: 51px;">
			<div id="gui"></div>
		</div>

		<script type="text/javascript">
			var cloned=false;

			function clone(to,from,setting)
			{
				superstar_get(from,setting,function(obj)
				{
					superstar_set(to,setting,obj,function(obj){cloned=true;});
				});
			}

			function clone_reconnect(robot_name)
			{
				if(cloned)
					robot_connect.onconnect(robot_name);
				else
					setTimeout(function(){clone_reconnect(robot_name);},50);
			}




			var global_name=null;
			var div=document.getElementById("gui");
			var disconnected_text="<font style='color:red;'>Disconnected</font>";

			var robot_clone=null;
			var robot_connect=null;
			var menu=null;
			var gui=null;
			var gui_interval=null;
			var gui_old="";
			var config_editor=null;
			var state_table=null;
			var pilot_interface=null;
			var doorways={};






			function gui_download()
			{
				if(!global_name)
					return;

				var robot_name=global_name;

				superstar_get(robot_name,"gui",function(json)
				{
					gui.load(json);
					create_widgets();
					robot_clone.clone_target=global_name;
					config_editor.download(global_name);
					state_table.download(global_name);
					gui_interval=setInterval(gui_upload,1000);
				});
			}

			function gui_upload()
			{
				var save=gui.save();
				var stringified=JSON.stringify(save);

				if(global_name&&gui_old!=stringified)
				{
					superstar_set(global_name,"gui",save);
					gui_old=stringified;
				}
			}






















			function create_menus()
			{
				menu=new robot_menu_t(div);
				robot_connect=new modal_connect_t(div);
				robot_clone=new modal_clone_t(div);

				if(!menu)
					alert("Could not create robot menu!");
				if(!robot_connect)
					alert("Could not create robot connect modal!");
				if(!robot_clone)
					alert("Could not create robot clone modal!");

				menu.get_status_area().innerHTML=disconnected_text;
				menu.create_button
				(
					"Robot",
					null,
					"glyphicon glyphicon-cog",
					{
						"Connect":
						{
							onclick:function(){robot_connect.show();},
							glyph:"glyphicon glyphicon-off"
						},
						"Clone":
						{
							onclick:function(){robot_clone.show();},
							glyph:"glyphicon glyphicon-duplicate"
						}
					}
				);
				menu.buttons["Robot"].drops["Clone"].disable();

				robot_connect.onconnect=function(robot_name)
				{
					if(robot_name)
					{
						global_name=null;
						clearInterval(gui_interval);
						gui_interval=null;
						global_name=robot_name;
						menu.get_status_area().innerHTML="Connected to \""+global_name+"\"";
						menu.buttons["Robot"].drops["Clone"].enable();
						gui_download();
					}
				};
				robot_clone.clone_target=global_name;
				robot_clone.onclone=function(robot_name,settings,options)
				{
					if(robot_clone.clone_target)
					{
						for(var key in settings)
							clone(robot_name,robot_clone.clone_target,settings[key]);

						var connect_to_clone=false;

						for(var key in options)
						{
							if(options[key]=="connect_to_clone")
								connect_to_clone=true;
						}

						if(connect_to_clone)
							clone_reconnect(robot_name);
					}
				};
			}

			function create_gui()
			{
				gui=new doorways_t(div);

				if(!gui)
					alert("Could not create gui!");
			}
			
			function create_doorway(window_title) 
			{
				var w=gui.get_by_title(window_title);
				if (w) return w;
				else return gui.create(window_title);
			}

			function create_widgets()
			{
				doorways={}; // clean out old doorways
				
				doorways.config=create_doorway("Configure");
				config_editor=new config_editor_t(doorways.config.content,global_name);

				doorways.pilot=create_doorway("Drive");
				pilot_interface=new pilot_interface_t(doorways.pilot.content);

				doorways.sensor=create_doorway("Sensor");
				sensor_display=new tree_viewer_t(doorways.sensor.content,{});
				
				// HACKITY HACK: fill initial sensor data.  Needs to be in set_interval.
				superstar_get(global_name,"sensors",
					function(sensor_data) {
						sensor_display.refresh(sensor_data);
					});
				
				doorways.states=create_doorway("Code");
				state_table=new state_table_t(doorways.states.content);

				if(!config_editor)
					alert("Could not create config editor!");
				if(!state_table)
					alert("Could not create state table!");
				if(!pilot_interface)
					alert("Could not create pilot interface!");

				config_editor.onconfigure=function()
				{
					if(global_name)
						config_editor.upload(global_name);
				}
				state_table.onrun=function()
				{
					if(global_name)
						state_table.upload(global_name);
				}
				pilot_interface.onpilot=function(power)
				{
					console.log("Pilot! - "+JSON.stringify(power));
						if(global_name)
							pilot_interface.upload(global_name);
				}
			}

			create_menus();
			create_gui();
			robot_connect.show();
		</script>
	</body>
</html>

<html lang="en">
	<head>
		<!--#include virtual="/sources.html"-->
		<!--#include virtual="/navbar.html"-->
	</head>
	<body role="document">
		<div style="padding-top: 51px;">
			<div id="gui"></div>
		</div>

		<script type="text/javascript">
			var cloned=false;

			function clone(to,from,setting)
			{
				superstar_get(from,setting,function(obj)
				{
					superstar_set(to,setting,obj,function(obj){cloned=true;});
				});
			}

			function clone_reconnect(robot_name)
			{
				if(cloned)
					menu.connect.onconnect(robot_name);
				else
					setTimeout(function(){clone_reconnect(robot_name);},50);
			}




			var global_name=null;
			var div=document.getElementById("gui");
			var disconnected_text="<font style='color:red;'>Disconnected</font>";

			var menu=
			{
				element:null,
				connect:null,
				clone:null
			};
			var gui=
			{
				interval:null,
				old:"",
				widgets:{}
			};
			var doorways={};





			function gui_download()
			{
				if(!global_name)
					return;

				var robot_name=global_name;

				superstar_get(robot_name,"gui",function(json)
				{
					gui.load(json);
					create_widgets();
					menu.clone.clone_target=global_name;
					gui.widgets.config.download(global_name);
					gui.widgets.states.download(global_name);
					gui.interval=setInterval(gui_upload,1000);
				});
			}

			function gui_upload()
			{
				var save=gui.save();
				var stringified=JSON.stringify(save);

				if(global_name&&gui.old!=stringified)
				{
					superstar_set(global_name,"gui",save);
					gui.old=stringified;
				}
			}






















			function create_menus()
			{
				menu.bar=new robot_menu_t(div);
				menu.connect=new modal_connect_t(div);
				menu.clone=new modal_clone_t(div);

				if(!menu.bar)
					alert("Could not create robot menu!");
				if(!menu.connect)
					alert("Could not create robot connect modal!");
				if(!menu.clone)
					alert("Could not create robot clone modal!");

				menu.bar.get_status_area().innerHTML=disconnected_text;
				menu.bar.create_button
				(
					"Robot",
					null,
					"glyphicon glyphicon-cog",
					{
						"Connect":
						{
							onclick:function(){menu.connect.show();},
							glyph:"glyphicon glyphicon-off"
						},
						"Clone":
						{
							onclick:function(){menu.clone.show();},
							glyph:"glyphicon glyphicon-duplicate"
						}
					}
				);
				menu.bar.buttons["Robot"].drops["Clone"].disable();

				menu.connect.onconnect=function(robot_name)
				{
					if(robot_name)
					{
						global_name=null;
						clearInterval(gui.interval);
						gui.interval=null;
						global_name=robot_name;
						menu.bar.get_status_area().innerHTML="Connected to \""+global_name+"\"";
						menu.bar.buttons["Robot"].drops["Clone"].enable();
						gui_download();
					}
				};
				menu.clone.clone_target=global_name;
				menu.clone.onclone=function(robot_name,settings,options)
				{
					if(menu.clone.clone_target)
					{
						for(var key in settings)
							clone(robot_name,menu.clone.clone_target,settings[key]);

						var connect_to_clone=false;

						for(var key in options)
						{
							if(options[key]=="connect_to_clone")
								connect_to_clone=true;
						}

						if(connect_to_clone)
							clone_reconnect(robot_name);
					}
				};
			}

			function create_gui()
			{
				gui=new doorways_t(div);

				if(!gui)
					alert("Could not create gui!");
			}

			function create_doorway(window_title)
			{
				var w=gui.get_by_title(window_title);
				if (w) return w;
				else return gui.create(window_title);
			}

			function create_widgets()
			{
				doorways={}; // clean out old doorways
				
				doorways.config=create_doorway("Configure");
				doorways.pilot=create_doorway("Drive");
				doorways.sensor=create_doorway("Sensor");
				doorways.states=create_doorway("Code");

				gui.widgets=
				{
					config:new config_editor_t(doorways.config.content,global_name),
					states:new state_table_t(doorways.states.content),
					pilot:new pilot_interface_t(doorways.pilot.content),
					sensor:new tree_viewer_t(doorways.sensor.content,{}),
				};
				
				// HACKITY HACK: fill initial sensor data.  Needs to be in set_interval.
				superstar_get(global_name,"sensors",
					function(sensor_data) {
						gui.widgets.sensor.refresh(sensor_data);
					});

				gui.widgets.config.onconfigure=function()
				{
					if(global_name)
						gui.widgets.config.upload(global_name);
				}
				gui.widgets.states.onrun=function()
				{
					if(global_name)
						gui.widgets.states.upload(global_name);
				}
				gui.widgets.pilot.onpilot=function(power)
				{
					if(global_name)
						gui.widgets.pilot.upload(global_name);
				}
			}

			create_menus();
			create_gui();
			menu.connect.show();
		</script>
	</body>
</html>

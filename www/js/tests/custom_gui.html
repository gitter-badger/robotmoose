<html lang="en">
	<head>
		<!--#include virtual="/sources.html"-->
		<!--#include virtual="/navbar.html"-->
	</head>
	<body role="document">
		<div style="padding-top: 51px;">
			<div id="gui"></div>
		</div>

		<script type="text/javascript">
			var cloned=false;

			function clone(to,from,setting)
			{
				superstar_get(from,setting,function(obj)
				{
					superstar_set(to,setting,obj,function(obj){cloned=true;});
				});
			}

			function clone_reconnect(robot_name)
			{
				if(cloned)
					robot_connect.onconnect(robot_name);
				else
					setTimeout(function(){clone_reconnect(robot_name);},50);
			}




			var global_name=null;
			var div=document.getElementById("gui");
			var disconnected_text="<font style='color:red;'>Disconnected</font>";

			var robot_clone=null;
			var robot_connect=null;
			var menu=null;
			var gui=null;
			var gui_interval=null;
			var config_editor=null;
			var state_table=null;
			var pilot_interface=null;






			function gui_download()
			{
				if(!global_name)
					return;

				var robot_name=global_name;

				superstar_get(robot_name,"gui",function(json)
				{
					gui.load(json);
					gui_interval=setInterval(gui_upload,1000);
				});
			}

			function gui_upload()
			{
				if(global_name)
					superstar_set(global_name,"gui",gui.save());
			}






















			function create_menus()
			{
				menu=new robot_menu_t(div);
				robot_connect=new modal_connect_t(div);
				robot_clone=new modal_clone_t(div);

				if(!menu)
					alert("Could not create robot menu!");
				if(!robot_connect)
					alert("Could not create robot connect modal!");
				if(!robot_clone)
					alert("Could not create robot clone modal!");

				menu.get_status_area().innerHTML=disconnected_text;
				menu.create_button
				(
					"Robot",
					null,
					"glyphicon glyphicon-cog",
					{
						"Connect":
						{
							onclick:function(){robot_connect.show();},
							glyph:"glyphicon glyphicon-off"
						},
						"Clone":
						{
							onclick:function(){robot_clone.show();},
							glyph:"glyphicon glyphicon-duplicate"
						}
					}
				);
				menu.buttons["Robot"].drops["Clone"].disable();

				robot_connect.onconnect=function(robot_name)
				{
					if(robot_name)
					{
						global_name=null;
						clearInterval(gui_interval);
						gui_interval=null;
						global_name=robot_name;
						robot_clone.clone_target=global_name;
						config_editor.download(global_name);
						state_table.download(global_name);
						menu.get_status_area().innerHTML="Connected to \""+global_name+"\"";
						menu.buttons["Robot"].drops["Clone"].enable();
						gui_download();
					}
				};
				robot_clone.clone_target=global_name;
				robot_clone.onclone=function(robot_name,settings,options)
				{
					if(robot_clone.clone_target)
					{
						for(var key in settings)
							clone(robot_name,robot_clone.clone_target,settings[key]);

						var connect_to_clone=false;

						for(var key in options)
						{
							if(options[key]=="connect_to_clone")
								connect_to_clone=true;
						}

						if(connect_to_clone)
							clone_reconnect(robot_name);
					}
				};
			}

			function create_gui()
			{
				gui=new doorways_t(div);

				if(!gui)
					alert("Could not create gui!");
			}

			function create_windows()
			{
				gui.create_window("Configuration",0,0);
				gui.create_window("States",0,0);
				gui.create_window("Pilot",0,0);

				config_editor=new config_editor_t(gui.get_window("Configuration").body.content,global_name);
				state_table=new state_table_t(gui.get_window("States").body.content);
				pilot_interface=new pilot_interface_t(gui.get_window("Pilot").body.content);

				if(!config_editor)
					alert("Could not create config editor!");
				if(!state_table)
					alert("Could not create state table!");
				if(!pilot_interface)
					alert("Could not create pilot interface!");

				config_editor.onrefresh=function(){gui.refresh_windows_m();};
				state_table.onrefresh=function(){gui.refresh_windows_m();};

				config_editor.onconfigure=function()
				{
					if(global_name)
						config_editor.upload(global_name);
				}
				state_table.onrun=function()
				{
					if(global_name)
						state_table.upload(global_name);
				}
				pilot_interface.onpilot=function(power)
				{
					console.log("Pilot! - "+JSON.stringify(power));
						if(global_name)
							pilot_interface.upload(global_name);
				}
			}

			create_menus();
			create_gui();
			create_windows();
		</script>
	</body>
</html>
